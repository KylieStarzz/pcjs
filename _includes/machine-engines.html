{% comment %}

As discussed in /modules/markout/lib/markout.js, our Node web server recognizes the following machine properties
in the Front Matter of our Markdown documents, for compatibility with the Jekyll web server:

    'id' (eg: ibm5150)
    'name' (eg: "IBM PC (Model 5150) with Monochrome Display")
    'type' (eg: c1p, pcx86, pc8080, pdp10, pdp11, leds, ti42, ti55, ti57)
    'debugger' (default: false)
    'config' (default: machine.xml)
    'template' (default: machine.xsl)
    'debug' (default: false; true enables asserts and is much slower)
    'uncompiled' (default: false; true is useful for debugging but slower)
    'parms' (stringified object that collects additional machine properties listed below)

Note that if you want BACKTRACK support enabled in a machine, both 'debugger' and 'uncompiled' must be true.
Also note that while multiple machines ARE supported on a single page, there are some limitations; for example,
loading two or more machines of the same 'type' but with different 'debug', 'uncompiled', or 'debugger' settings
may not work as desired.

The following optional machine properties will be added to the 'parms' property:

    'autoMount' (eg: {"A":{"name":"OS/2 FOOTBALL (v7.68.17)","path":"/disks/pc/os2/misc/football/FOOTBALL-76817.json"}})
    'autoPower' (eg: true)
    'autoScript' (eg, type Keyboard "$date\r$time\r")
    'autoStart' (eg: true)
    'autoType' (eg: $date\r$time\r)
    'drives' (eg: '[{name:"68Mb Hard Disk",type:4,path:"http://archive.pcjs.org/disks/pc/fixed/68mb/win95.json"}]')
    'resume' (eg: 1)
    'state' (eg: state.json)
    'commands' (debugger commands, if any)
    'messages' (eg: fault)
    'connection' (eg: serialPort->vt100a.serialPort)

{% endcomment %}
{% for machine in page.machines %}
  {% capture machine_type %}{{ machine.type | remove:"-dbg" }}{% endcapture %}
  {% assign machine_data = site.data.machines[machine_type] %}
  {% if machine_data.alias != nil %}
    {% assign machine_data = site.data.machines[machine_data.alias] %}
  {% endif %}
  {% assign machine_folder = machine_data.folder %}
  {% unless machine.config %}
    {% assign machine_config = "machine.xml" %}
  {% else %}
    {% assign machine_config = machine.config %}
  {% endunless %}
  {% capture machine_embed %}{{ machine_data.creator }}{% endcapture %}
  {% if machine_data.version == nil %}
    {% capture machine_version %}{{ site.pcjs.version }}{% endcapture %}
  {% else %}
    {% capture machine_version %}{{ machine_data.version }}{% endcapture %}
  {% endif %}
  {% if machine.autoMount == "" %}
    {% assign machine_autoMount = "{}" %}
  {% else %}
    {% capture machine_autoMount %}{{ machine.autoMount|jsonify }}{% endcapture %}
  {% endif %}
  {% if machine.autoPower != nil %}
    {% capture machine_autoPower %},autoPower:{{ machine.autoPower }}{% endcapture %}
  {% else %}
    {% assign machine_autoPower = "" %}
  {% endif %}
  {% if machine.autoScript != nil %}
    {% capture machine_autoScript %},autoScript:"{{ page.machineScripts[machine.autoScript] | strip_newlines | replace:'"':"\\\\&quot;" | replace:"\r":"\\\\r" | replace:"\n":"\\\\n" | replace:"\t":"\\\\t" | replace:"\x":"\\\\x" }}"{% endcapture %}
  {% else %}
    {% assign machine_autoScript = "" %}
  {% endif %}
  {% if machine.autoStart != nil %}
    {% capture machine_autoStart %},autoStart:{{ machine.autoStart }}{% endcapture %}
  {% else %}
    {% assign machine_autoStart = "" %}
  {% endif %}
  {% if machine.autoType != nil %}
    {% capture machine_autoType %},autoType:"{{ machine.autoType | replace:"\r":"\\\\r" | replace:"\n":"\\\\n" | replace:"\t":"\\\\t" | replace:"\x":"\\\\x" }}"{% endcapture %}
  {% else %}
    {% assign machine_autoType = "" %}
  {% endif %}
  {% if machine.drives != nil %}
    {% if machine.drives == "" %}
      {% assign machine_drives = ",drives:[]" %}
    {% else %}
      {% capture machine_drives %},drives:{{ machine.drives }}{% endcapture %}
    {% endif %}
  {% else %}
    {% assign machine_drives = "" %}
  {% endif %}
  {% unless machine.template %}
    {% assign machine_template = "" %}
  {% else %}
    {% assign machine_template = machine.template %}
  {% endunless %}
  {% capture machine_parms %}{{ site.left_brace }}autoMount:{{ machine_autoMount }}{{ machine_autoPower }}{{ machine_autoScript }}{{ machine_autoStart }}{{ machine_autoType }}{{ machine_drives }},resume:"{{ machine.resume }}",state:"{{ machine.state }}",commands:"{{ machine.commands }}",messages:"{{ machine.messages }}",connection:"{{ machine.connection }}"{{ site.right_brace }}{% endcapture %}
  {% if site.pcjs.compiled == true and machine.uncompiled != true %}
    {% capture page_script %}
      <script type="text/javascript" src="{{ site.baseurl }}/versions/{{ machine_folder }}/{{ machine_version }}/{{ machine_type }}.js"></script>{% endcapture %}
    {% unless page_scripts contains page_script %}
      {{ page_script }}
    {% endunless %}
    {% capture page_scripts %}{{ page_scripts }}{{ page_script }}{% endcapture %}
    {% if machine_template == "" %}
      {% capture machine_template %}{{ site.baseurl }}/versions/{{ machine_folder }}/{{ machine_version }}/components.xsl{% endcapture %}
    {% endif %}
  {% else %}
    {% capture page_script %}
    <script type="text/javascript" src="{{ site.baseurl }}/versions/{{ machine_folder }}/{{ machine_version }}/{{ machine_type }}-uncompiled.js"></script>{% endcapture %}
    {% unless page_scripts contains page_script %}
      {{ page_script }}
    {% endunless %}
    {% capture page_scripts %}{{ page_scripts }}{{ page_script }}{% endcapture %}
    {% if machine_template == "" %}
      {% capture machine_template %}{{ site.baseurl }}/versions/{{ machine_folder }}/{{ machine_version }}/components.xsl{% endcapture %}
    {% endif %}
  {% endif %}
  {% if machine_embed contains "new " %}
    <script type="text/javascript">{{ machine_embed }}('{{ machine.id }}','{{ machine_config | strip_newlines }}');</script>
  {% else %}
    <script type="text/javascript">{{ machine_embed }}('{{ machine.id }}','{{ machine_config }}','{{ machine_template }}','{{ machine_parms }}');</script>
  {% endif %}
  {% if machine.sticky == "top" %}
    <script type="text/javascript" src="{{ site.baseurl }}/modules/shared/lib/sticky.js"></script>
    <script type="text/javascript">addStickyMachine('{{ machine.id }}');</script>
  {% endif %}
  {% if page.build %}
    <script type="text/javascript" src="{{ site.baseurl }}/modules/build/lib/build.js"></script>
    <script type="text/javascript">buildPC("{{ page.build }}");</script>
  {% endif %}
{% endfor %}
